name: Generate and Check IP Availability

on:
  schedule:
    - cron: '0 * * * *'  # 每小时运行一次
  workflow_dispatch:  # 支持手动触发工作流

jobs:
  generate-ip-file:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3  # 检出仓库代码

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.9  # 使用 Python 3.9

    - name: Generate port.txt file
      run: |
        python scripts/bbb/generate_port_txt.py  # 生成最新的 port.txt 文件

  check-ips:
    needs: generate-ip-file  # 确保只有生成了 port.txt 后才进行 IP 检查
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3  # 再次检出仓库代码，以便读取生成的 port.txt 文件

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.9  # 使用 Python 3.9

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests  # 如果脚本中用到了 requests 库

    - name: Run IP check script
      run: python scripts/bbb/check_ips.py  # 运行测试脚本
